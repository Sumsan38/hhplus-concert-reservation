# 시나리오 및 요구사항 분석
- 실시간 트래픽 대응을 위해 대기열 시스템이 포함된다.
- 사용자는 포인트를 충전하고 조회할 수 있다.
- 사용자별로 포인트 히스토리 내역(```CAHRGE```, ```USE```)을 가진다.
- 사용자는 하나의 좌석에 대해서 예약을 진행한다.
- 사용자는 먼저 좌석을 선점(```HELD```)하고 후에 포인트를 통해 결제를 진행한다.
- 결제가 완료되면 해당 좌석은 예약 완료(```RESERVED```) 상태가 된다.
- 예약을 진행한 사용자에 의해 결제가 이루어지지 않는다면 임시 배정은 해제(```CANCELED```)되며 다른 사용자는 예약할 수 없다.
- 해제(```CANCELED```)된 좌석은 매일 오전 9시에 다시 예약 가능한 상태로 변경된다. 

---
## 핵심 시나리오 및 흐름
1. 대기열 진입
   - 사용자는 서비스 접속시 대기열 토큰을 발급 받는다.
     - 유저 토큰: 유저의 UUID와 해당 유저의 대기열을 관리할 수 있는 정보(대기 순서 or 잔여 시간 등)
   - Redis를 통해 대기 순서 및 입장 조건 제어
   - **입장 가능 상태**가 될 때 까지만 대기열 외 API 사용 제한
2. 예약 가능한 날짜 및 좌석 조회
   - 예약 가능한 콘서트 날짜 조회
   - 콘서트 날짜 별로 좌석 목록 (1~50번) 조회
3. 좌석 예약 요청
   - 좌석 상태의 경우 ```AVAILABLE```, ```HELD```, ```RESERVED```, ```CANCELED``` 중 하나
   - ```AVAILABLE```인 상태의 좌석만 예약을 진행 가능
   - 예약 요청이 들어올 경우 좌석에 대해서  ```HELD``` 상태로 저장
   - 좌석 선택시 Redis에 TTL을 5으로 설정
   - Kafka로 예약 요청 메시지 전송 -> 좌석 상태를 동기화
   - TTL을 설정할 때, Kafka Topic으로 만료 시간을 포함한 만료 메세지를 발행 
4. 잔액 충전/조회
   - 사용자는 자신의 포인트 잔액을 충전, 조회 가능
   - 결제 전 잔액을 확인하고 진행
5. 결제 요청
   - 결제 API 호출시,
     - 포인트 잔액 검증 및 차감
     - 좌석 상태 ```RESERVED```로 변경
     - 대기열 토큰 만료 처리
6. 임시 예약 만료 처리
   - Redis TTL이 만료된 좌석은 ```CANCELED```로 업데이트 후 Redis에서 삭제
   - 차후 Spring Scheduler에 의해 매일 오전 9시에 ```CANCELED``` 상태 값인 좌석을 ```AVAILABLE```로 복원하여 다른 유저들에게 오픈

---
## 기능적 요구사항
| 기능           | 정의                                                                                                                                                                                                                                     |
|--------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 대기열 토큰 발급    | 사용자가 예약 프로그램 접속시 대기열 진입 및 입장 토큰을 발급받는다.                                                                                                                                                                                                |
| 대기열 검증       | 모든 API는 토큰 유효성 검증을 통해 대기열 순서를 통과해야 접근이 가능하다.                                                                                                                                                                                           |
| 콘서트 예약 날짜 조회 | 예약 가능한 콘서트 날짜 리스트를 조회한다. 이 단계에서 조회 당시의 잔여 좌석 개수도 함께 조회된다.                                                                                                                                                                              |
| 좌석 조회        | 예약 가능한 날짜를 통해 잔여 좌석(1~50)을 조회한다.                                                                                                                                                                                                       |
| 좌석 예약 요청     | 사용자가 좌석을 선택한다. 해당 좌석을 사용자에게 5분동안 배정한다(```HELD```). Redis TTL을 적용한다.                                                                                                                                                                    |
| 좌석 상태 유지     | ```HELD```상태의 좌석은 다른 사용자가 접근 불가하다.                                                                                                                                                                                                     |
| 결제           | 사용자의 잔액 확인 후 좌석 결제 및 소유권을 확정하고 좌석 상태 값을 ```RESERVED```로 업데이트한다. 사용자의 대기열 토큰을 만료처리한다.                                                                                                                                                   |
| 포인트 충전       | 사용자의 포인트 충전 기능을 제공한다.                                                                                                                                                                                                                  |
| 포인트 잔액 조회    | 사용자의 현태 포인트 잔액 조회 기능을 제공한다.                                                                                                                                                                                                            |
| 예약 만료 복구     | TTL이 만료된 경우 ```Consumer```쪽에서 ```Executors.newSingleThreadScheduledExecutor().schedule(...)```를 사용하여 좌석의 상태 값을 ```CANCELED```로 업데이트한다.<br/>Spring Schduler를 통해 매일 오전 9시에 ```CANCELED``` 상태 값인 좌석을 ```AVAILABLE```로 복원하여 다른 유저들에게 오픈한다. |
| Kafka 이벤트 처리 | 예약 요청 및 결제 처리 등 주요 트랜잭션은 Kafka 비동기 이벤트 처리 방식을 적용한다.                                                                                                                                                                                    |

---
## 비기능적 요구사항
| 기능          | 정의                                                                                                                                   |
|-------------|--------------------------------------------------------------------------------------------------------------------------------------|
| 응답 시간       | 예약 가능 날짜, 좌석 조회는 1초 이내, 예약 요청은 2초 이내 응답하도록 개발한다.                                                                                     |
| TPS         | 매일 오전 9시 예약이 몰리는 피크 시간 기준 1000 req/min 수준의 부하를 견디도록 설계한다. (Redis 캐싱, Kafka 기반 Message를 통한 비동기 처리)                                    |
| 비동기 처리      | Kafka 기반으로 예약/결제는 비동기 큐 처리한다.                                                                                                        |
| 인증          | JWT 기반 인증을 구현한다                                                                                                                      |
| 버전링         | API는 ```/api/v1/**```과 같이 버전링된 URI를 갖는다.                                                                                             |
| 좌석 예약 중복 방지 | Redis Lock을 사용하여 동일 좌석에 대한 중복 예약을 차단한다.                                                                                              |
| 결제 멱등성 처리   | 결제 API는 재시도 방지 목적의 ```Idempotency-Key```를 Header 적용 (권장)                                                                             |
| 유지보수        | 계층 분리: Controller -> Service -> Repository 계층 구조로 진행<br/>도메인 별 패키지 분리(DDD)<br/>공통 예외 처리: ResponseEntity<ResponseDto>를 정의해 일관된 응답 값 보장 |
| 테스트         | 모든 도메인 서비스 및 컨트롤러 단위 테스트 red-green-refactoring 단계로 작성<br/>Kafka Consumser의 경우 Stub로 테스트                                              |
| 로그          | 좌석 예약, 결제, 좌석 만료 처리에 대한 주요 로그를 작성한다                                                                                                  |
| 모니터링        | Prometheus + Grafana 기반으로 모니터링 시각화                                                                                                   |

[돌아가기](../README.md)